<!DOCTYPE html>
<html>
<head>
    <title>Add Product Images</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 40px; line-height: 1.6; }
        .form-group { margin: 20px 0; }
        label { display: block; font-weight: bold; margin-bottom: 5px; }
        select, input { padding: 8px; margin: 5px 0; width: 300px; }
        button { padding: 10px 20px; background: #007bff; color: white; border: none; cursor: pointer; margin: 10px 0; }
        button:hover { background: #0056b3; }
        .success { color: green; font-weight: bold; }
        .error { color: red; font-weight: bold; }
        #upload-area { border: 2px dashed #ddd; padding: 20px; text-align: center; margin: 20px 0; }
        .image-preview { max-width: 200px; margin: 10px; border: 2px solid #ddd; }
    </style>
</head>
<body>
    <h1>Add Images to Product</h1>
    
    <div class="form-group">
        <label for="product-select">Select Product:</label>
        <select id="product-select">
            <option value="">Loading products...</option>
        </select>
        <button onclick="loadProducts()">Refresh Products</button>
    </div>
    
    <div class="form-group">
        <label>Upload Image:</label>
        <div id="upload-area" onclick="document.getElementById('file-input').click()">
            <p>Click to select an image or drag and drop</p>
            <input type="file" id="file-input" accept="image/*" style="display: none;" onchange="uploadImage()">
        </div>
    </div>
    
    <div id="result"></div>
    <div id="images-display"></div>
    
    <script>
        let products = [];
        
        async function loadProducts() {
            try {
                const response = await fetch('/api/admin/supplier-products');
                if (response.ok) {
                    products = await response.json();
                    const select = document.getElementById('product-select');
                    select.innerHTML = '<option value="">Select a product...</option>';
                    
                    products.forEach(product => {
                        const option = document.createElement('option');
                        option.value = product.id;
                        option.textContent = product.productName || product.name;
                        select.appendChild(option);
                    });
                } else {
                    console.error('Failed to load products');
                }
            } catch (error) {
                console.error('Error loading products:', error);
            }
        }
        
        async function uploadImage() {
            const fileInput = document.getElementById('file-input');
            const productSelect = document.getElementById('product-select');
            const result = document.getElementById('result');
            
            if (!fileInput.files[0]) {
                result.innerHTML = '<p class="error">Please select an image file</p>';
                return;
            }
            
            if (!productSelect.value) {
                result.innerHTML = '<p class="error">Please select a product first</p>';
                return;
            }
            
            const file = fileInput.files[0];
            result.innerHTML = '<p>Uploading image...</p>';
            
            try {
                // Step 1: Get upload URL
                const uploadResponse = await fetch('/api/objects/upload', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' }
                });
                
                if (!uploadResponse.ok) {
                    throw new Error(`Failed to get upload URL: ${uploadResponse.status}`);
                }
                
                const { uploadURL } = await uploadResponse.json();
                
                // Step 2: Upload to Google Cloud Storage
                const uploadCloudResponse = await fetch(uploadURL, {
                    method: 'PUT',
                    body: file,
                    headers: { 'Content-Type': file.type }
                });
                
                if (!uploadCloudResponse.ok) {
                    throw new Error(`Failed to upload to cloud: ${uploadCloudResponse.status}`);
                }
                
                // Step 3: Set ACL policy
                const aclResponse = await fetch('/api/admin/images', {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ 
                        imageURL: uploadURL.split('?')[0] 
                    })
                });
                
                if (!aclResponse.ok) {
                    throw new Error(`ACL setting failed: ${aclResponse.status}`);
                }
                
                const aclData = await aclResponse.json();
                
                // Step 4: Update product with image
                const updateResponse = await fetch(`/api/admin/supplier-products/${productSelect.value}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ 
                        imageUrl: aclData.objectPath 
                    })
                });
                
                if (!updateResponse.ok) {
                    throw new Error(`Failed to update product: ${updateResponse.status}`);
                }
                
                result.innerHTML = `
                    <p class="success">âœ“ Image added successfully!</p>
                    <p>Object path: ${aclData.objectPath}</p>
                    <img src="/simple-image${aclData.objectPath}" class="image-preview" alt="Uploaded image">
                `;
                
                // Clear the file input
                fileInput.value = '';
                
            } catch (error) {
                console.error('Upload failed:', error);
                result.innerHTML = `<p class="error">Upload failed: ${error.message}</p>`;
            }
        }
        
        // Load products on page load
        window.onload = loadProducts;
    </script>
</body>
</html>